{% extends "base.html" %}

{% block title %}AI Insights & Summaries - LogSage AI{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">AI Insights & Summaries</h1>
        <p class="text-gray-600 mb-4">Generate intelligent summaries and insights from your log data</p>
    </div>

    <!-- File Selection Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Select Log File</h2>
        <div class="flex items-center space-x-4">
            <select id="fileSelect" class="bg-white border border-gray-300 rounded-md px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 flex-1">
                <option value="">Select a log file...</option>
            </select>
            <button id="refreshFiles" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors">
                <i class="fas fa-sync-alt mr-2"></i>Refresh
            </button>
        </div>
    </div>

    <!-- Summary Options Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Summary Options</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button id="generateDaily" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-md transition-colors">
                <i class="fas fa-calendar-day mr-2"></i>Daily Summary
            </button>
            <button id="generateWeekly" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-md transition-colors">
                <i class="fas fa-calendar-week mr-2"></i>Weekly Summary
            </button>
            <button id="generateInsights" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-md transition-colors">
                <i class="fas fa-lightbulb mr-2"></i>Generate Insights
            </button>
        </div>
        
        <!-- Date Selection for Custom Summaries -->
        <div id="dateSelection" class="mt-4 hidden">
            <label for="summaryDate" class="block text-sm font-medium text-gray-700 mb-2">Select Date (for daily/weekly summary):</label>
            <input type="date" id="summaryDate" class="bg-white border border-gray-300 rounded-md px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
        <div class="flex items-center">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
            <span class="text-blue-700">Generating insights...</span>
        </div>
    </div>

    <!-- Summary Results Section -->
    <div id="summaryResults" class="hidden">
        <!-- Daily Summary Card -->
        <div id="dailySummaryCard" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Daily Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="text-sm font-medium text-blue-900">Total Logs</h3>
                    <p id="dailyTotalLogs" class="text-2xl font-bold text-blue-600">-</p>
                </div>
                <div class="bg-red-50 p-4 rounded-lg">
                    <h3 class="text-sm font-medium text-red-900">Error Rate</h3>
                    <p id="dailyErrorRate" class="text-2xl font-bold text-red-600">-</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <h3 class="text-sm font-medium text-yellow-900">Peak Hour</h3>
                    <p id="dailyPeakHour" class="text-2xl font-bold text-yellow-600">-</p>
                </div>
            </div>
            <div class="border-t pt-4">
                <h3 class="font-medium text-gray-800 mb-2">Summary</h3>
                <p id="dailySummaryText" class="text-gray-600 mb-4">-</p>
                
                <h3 class="font-medium text-gray-800 mb-2">Key Insights</h3>
                <ul id="dailyInsights" class="list-disc list-inside text-gray-600 mb-4"></ul>
                
                <h3 class="font-medium text-gray-800 mb-2">Recommendations</h3>
                <ul id="dailyRecommendations" class="list-disc list-inside text-gray-600"></ul>
            </div>
        </div>

        <!-- Weekly Summary Card -->
        <div id="weeklySummaryCard" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Weekly Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="text-sm font-medium text-blue-900">Total Logs</h3>
                    <p id="weeklyTotalLogs" class="text-2xl font-bold text-blue-600">-</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="text-sm font-medium text-green-900">Avg Daily Logs</h3>
                    <p id="weeklyAvgLogs" class="text-2xl font-bold text-green-600">-</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h3 class="text-sm font-medium text-purple-900">Busiest Day</h3>
                    <p id="weeklyBusiestDay" class="text-lg font-bold text-purple-600">-</p>
                </div>
                <div class="bg-red-50 p-4 rounded-lg">
                    <h3 class="text-sm font-medium text-red-900">Total Errors</h3>
                    <p id="weeklyTotalErrors" class="text-2xl font-bold text-red-600">-</p>
                </div>
            </div>
            <div class="border-t pt-4">
                <h3 class="font-medium text-gray-800 mb-2">Weekly Overview</h3>
                <p id="weeklySummaryText" class="text-gray-600 mb-4">-</p>
                
                <!-- Daily breakdown chart would go here -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Daily Log Distribution</h4>
                    <div id="weeklyChart" class="h-32 flex items-end justify-center space-x-2">
                        <!-- Chart bars will be generated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- General Insights Card -->
        <div id="insightsCard" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">AI Insights</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-medium text-gray-800 mb-2">Key Patterns</h3>
                    <ul id="insightPatterns" class="list-disc list-inside text-gray-600 space-y-1"></ul>
                </div>
                <div>
                    <h3 class="font-medium text-gray-800 mb-2">Anomalies Detected</h3>
                    <ul id="insightAnomalies" class="list-disc list-inside text-gray-600 space-y-1"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div id="errorDisplay" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
        <div class="flex items-center">
            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
            <span id="errorMessage" class="text-red-700"></span>
        </div>
    </div>

    <!-- Export Section -->
    <div id="exportSection" class="hidden bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Export Summary</h2>
        <div class="flex space-x-4">
            <button id="exportJSON" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md transition-colors">
                <i class="fas fa-download mr-2"></i>Export as JSON
            </button>
            <button id="exportPDF" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition-colors" disabled>
                <i class="fas fa-file-pdf mr-2"></i>Export as PDF (Coming Soon)
            </button>
        </div>
    </div>
</div>

<script>
// Global variables
let currentFileId = '';
let currentSummaryData = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadFiles();
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('refreshFiles').addEventListener('click', loadFiles);
    document.getElementById('fileSelect').addEventListener('change', handleFileSelection);
    document.getElementById('generateDaily').addEventListener('click', () => generateSummary('daily'));
    document.getElementById('generateWeekly').addEventListener('click', () => generateSummary('weekly'));
    document.getElementById('generateInsights').addEventListener('click', () => generateSummary('insights'));
    document.getElementById('exportJSON').addEventListener('click', exportSummary);
}

async function loadFiles() {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        // For demo purposes, create some sample files
        const fileSelect = document.getElementById('fileSelect');
        fileSelect.innerHTML = '<option value="">Select a log file...</option>';
        
        // Add demo files
        const demoFiles = [
            { id: 'demo_1', name: 'application.log (2.5MB)' },
            { id: 'demo_2', name: 'error.log (1.2MB)' },
            { id: 'demo_3', name: 'access.log (5.8MB)' }
        ];
        
        demoFiles.forEach(file => {
            const option = document.createElement('option');
            option.value = file.id;
            option.textContent = file.name;
            fileSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading files:', error);
        showError('Failed to load files');
    }
}

function handleFileSelection() {
    const fileId = document.getElementById('fileSelect').value;
    currentFileId = fileId;
    
    if (fileId) {
        document.getElementById('dateSelection').classList.remove('hidden');
        // Set default date to today
        document.getElementById('summaryDate').valueAsDate = new Date();
    } else {
        document.getElementById('dateSelection').classList.add('hidden');
        hideResults();
    }
}

async function generateSummary(type) {
    if (!currentFileId) {
        showError('Please select a log file first');
        return;
    }
    
    showLoading();
    hideError();
    
    try {
        let summaryData;
        const selectedDate = document.getElementById('summaryDate').value;
        
        if (type === 'daily') {
            summaryData = await generateDemoSummary('daily', selectedDate);
            displayDailySummary(summaryData);
        } else if (type === 'weekly') {
            summaryData = await generateDemoSummary('weekly', selectedDate);
            displayWeeklySummary(summaryData);
        } else if (type === 'insights') {
            summaryData = await generateDemoSummary('insights');
            displayInsights(summaryData);
        }
        
        currentSummaryData = summaryData;
        document.getElementById('exportSection').classList.remove('hidden');
        
    } catch (error) {
        console.error('Error generating summary:', error);
        showError('Failed to generate summary');
    } finally {
        hideLoading();
    }
}

async function generateDemoSummary(type, date) {
    // Simulate API call with mock data
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    const baseData = {
        file_id: currentFileId,
        generated_at: new Date().toISOString(),
        total_logs: Math.floor(Math.random() * 10000) + 1000
    };
    
    if (type === 'daily') {
        return {
            ...baseData,
            date: date || new Date().toISOString().split('T')[0],
            summary: "Daily log analysis completed successfully. System showed normal operation with minor fluctuations during peak hours.",
            statistics: {
                log_levels: {
                    info: Math.floor(Math.random() * 5000) + 2000,
                    warning: Math.floor(Math.random() * 500) + 100,
                    error: Math.floor(Math.random() * 100) + 10,
                    debug: Math.floor(Math.random() * 1000) + 500
                },
                peak_hour: `${Math.floor(Math.random() * 12) + 9}:00`,
                peak_hour_count: Math.floor(Math.random() * 500) + 100
            },
            key_insights: [
                "Peak activity observed during business hours",
                "Error rate within acceptable thresholds",
                "No critical system failures detected",
                "Performance metrics stable throughout the day"
            ],
            recommendations: [
                "Monitor error patterns during peak hours",
                "Consider log rotation for optimal performance",
                "Review warning trends for potential issues"
            ],
            trends: {
                error_rate: (Math.random() * 5).toFixed(2),
                warning_rate: (Math.random() * 15).toFixed(2)
            }
        };
    } else if (type === 'weekly') {
        const dailyCounts = Array.from({length: 7}, () => Math.floor(Math.random() * 2000) + 500);
        return {
            ...baseData,
            week_start: date || new Date().toISOString().split('T')[0],
            summary: `Weekly analysis shows consistent logging patterns with ${baseData.total_logs} total entries across 7 days.`,
            weekly_trends: {
                average_daily_logs: Math.floor(dailyCounts.reduce((a, b) => a + b) / 7),
                busiest_day: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'][Math.floor(Math.random() * 5)],
                busiest_day_count: Math.max(...dailyCounts),
                quietest_day: ['Saturday', 'Sunday'][Math.floor(Math.random() * 2)],
                total_errors: Math.floor(Math.random() * 200) + 50,
                daily_log_counts: dailyCounts
            }
        };
    } else if (type === 'insights') {
        return {
            ...baseData,
            insights: [
                "Application startup times have improved by 15%",
                "Database connection pool utilization is optimal",
                "Authentication success rate is 99.2%",
                "API response times within SLA targets"
            ],
            anomalies: [
                "Unusual spike in memory usage detected at 14:30",
                "Temporary network latency increase during backup window",
                "Login attempts from new geographic region"
            ]
        };
    }
}

function displayDailySummary(data) {
    showResults();
    document.getElementById('dailySummaryCard').classList.remove('hidden');
    document.getElementById('weeklySummaryCard').classList.add('hidden');
    document.getElementById('insightsCard').classList.add('hidden');
    
    document.getElementById('dailyTotalLogs').textContent = data.total_logs.toLocaleString();
    document.getElementById('dailyErrorRate').textContent = data.trends.error_rate + '%';
    document.getElementById('dailyPeakHour').textContent = data.statistics.peak_hour;
    document.getElementById('dailySummaryText').textContent = data.summary;
    
    // Display insights
    const insightsList = document.getElementById('dailyInsights');
    insightsList.innerHTML = '';
    data.key_insights.forEach(insight => {
        const li = document.createElement('li');
        li.textContent = insight;
        insightsList.appendChild(li);
    });
    
    // Display recommendations
    const recommendationsList = document.getElementById('dailyRecommendations');
    recommendationsList.innerHTML = '';
    data.recommendations.forEach(rec => {
        const li = document.createElement('li');
        li.textContent = rec;
        recommendationsList.appendChild(li);
    });
}

function displayWeeklySummary(data) {
    showResults();
    document.getElementById('dailySummaryCard').classList.add('hidden');
    document.getElementById('weeklySummaryCard').classList.remove('hidden');
    document.getElementById('insightsCard').classList.add('hidden');
    
    document.getElementById('weeklyTotalLogs').textContent = data.total_logs.toLocaleString();
    document.getElementById('weeklyAvgLogs').textContent = data.weekly_trends.average_daily_logs.toLocaleString();
    document.getElementById('weeklyBusiestDay').textContent = data.weekly_trends.busiest_day;
    document.getElementById('weeklyTotalErrors').textContent = data.weekly_trends.total_errors;
    document.getElementById('weeklySummaryText').textContent = data.summary;
    
    // Create simple chart
    createWeeklyChart(data.weekly_trends.daily_log_counts);
}

function displayInsights(data) {
    showResults();
    document.getElementById('dailySummaryCard').classList.add('hidden');
    document.getElementById('weeklySummaryCard').classList.add('hidden');
    document.getElementById('insightsCard').classList.remove('hidden');
    
    // Display patterns
    const patternsList = document.getElementById('insightPatterns');
    patternsList.innerHTML = '';
    data.insights.forEach(insight => {
        const li = document.createElement('li');
        li.textContent = insight;
        patternsList.appendChild(li);
    });
    
    // Display anomalies
    const anomaliesList = document.getElementById('insightAnomalies');
    anomaliesList.innerHTML = '';
    data.anomalies.forEach(anomaly => {
        const li = document.createElement('li');
        li.textContent = anomaly;
        anomaliesList.appendChild(li);
    });
}

function createWeeklyChart(dailyCounts) {
    const chartContainer = document.getElementById('weeklyChart');
    chartContainer.innerHTML = '';
    
    const maxCount = Math.max(...dailyCounts);
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    
    dailyCounts.forEach((count, index) => {
        const barContainer = document.createElement('div');
        barContainer.className = 'flex flex-col items-center';
        
        const bar = document.createElement('div');
        bar.className = 'bg-blue-500 w-8 mb-1';
        bar.style.height = `${(count / maxCount) * 100}px`;
        
        const label = document.createElement('span');
        label.className = 'text-xs text-gray-600';
        label.textContent = days[index];
        
        barContainer.appendChild(bar);
        barContainer.appendChild(label);
        chartContainer.appendChild(barContainer);
    });
}

function showLoading() {
    document.getElementById('loadingState').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loadingState').classList.add('hidden');
}

function showResults() {
    document.getElementById('summaryResults').classList.remove('hidden');
}

function hideResults() {
    document.getElementById('summaryResults').classList.add('hidden');
    document.getElementById('exportSection').classList.add('hidden');
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorDisplay').classList.remove('hidden');
}

function hideError() {
    document.getElementById('errorDisplay').classList.add('hidden');
}

function exportSummary() {
    if (!currentSummaryData) {
        showError('No summary data to export');
        return;
    }
    
    const dataStr = JSON.stringify(currentSummaryData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `logsage_summary_${currentFileId}_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}
</script>
{% endblock %}